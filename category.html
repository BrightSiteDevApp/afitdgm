<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-70VSGR5WBW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-70VSGR5WBW');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Category - AFIT Digital Market</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="asset/style.css">
  <link rel="icon" href="img/app-logo.png" type="image/png" sizes="192x192">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
      /* Hide content until loaded */
      #category-grid { min-height: 50vh; }

      /* LOAD MORE BUTTON */
      #load-more-container { text-align: center; margin: 30px 0 50px; display: none; }
      #load-more-btn {
          background: #333; color: white; border: none; padding: 12px 30px;
          border-radius: 30px; font-weight: bold; cursor: pointer;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
      }
      #load-more-btn:active { transform: scale(0.95); }

      /* --- TEXT & MODAL STYLES --- */
      .ad-title {
          white-space: normal !important;
          line-height: 1.3;
          height: auto !important;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          margin-bottom: 5px;
      }
      .ad-desc-preview {
          font-size: 11px; color: #888;
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
          margin-bottom: 8px;
      }

      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .modal-sheet {
          background: white; width: 100%; max-width: 500px;
          border-radius: 20px 20px 0 0; padding: 25px;
          animation: slideUp 0.3s ease-out;
          position: relative;
      }

      /* ðŸ†• NEW CLASS FOR DESCRIPTION BOX */
      .modal-desc-box {
          max-height: 200px;
          overflow-y: auto;
          margin-bottom: 20px;
          background: #f9f9f9; /* Default Light Color */
          padding: 10px;
          border-radius: 10px;
      }

      /* Dark Mode Fixes */
      body.dark-mode #load-more-btn { background: #444; }
      body.dark-mode .modal-sheet { background: #1e1e1e !important; color: white; }
      body.dark-mode .ad-desc-preview { color: #aaa; }
      
      /* ðŸ†• DARK MODE FIX FOR DESCRIPTION BOX */
      body.dark-mode .modal-desc-box { background: #2a2a2a !important; }
      body.dark-mode #m-desc { color: #ddd !important; }
  </style>
</head>
<body>

  <script>
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
  </script>

  <div id="preloader">
    <div class="loader-content">
        <img src="img/logo-blue.png" alt="Loading..." class="loader-logo">
        <div class="loading-bar"></div>
    </div>
  </div>

  <div class="app-container">
    
    <div class="header">
      <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
      <span style="font-weight:bold; text-transform: capitalize;" id="page-title">Loading...</span>
    </div>

   <div class="cat-search-container">
        <div class="search-wrapper cat-search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="cat-search" class="search-input" placeholder="Search in this category...">
        </div>
    </div>

    <div style="padding: 15px; font-weight:bold; color:#555; font-size: 14px;">
        <span id="result-count">Checking stock...</span>
    </div>

    <div class="trending-grid" id="category-grid">
        </div>

    <div id="load-more-container">
        <button id="load-more-btn">Load More</button>
    </div>

    <div id="detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:end;">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h3 id="m-title" style="margin:0; font-size:18px; width:90%; line-height:1.3;">...</h3>
                <button onclick="document.getElementById('detail-modal').style.display='none'" style="background:none; border:none; font-size:24px; color:#555; cursor:pointer;">&times;</button>
            </div>
            <p id="m-price" style="color:#2d8eff; font-weight:bold; font-size:20px; margin:10px 0;">...</p>
            
            <div class="modal-desc-box">
                 <p id="m-desc" style="color:#555; font-size:14px; line-height:1.5; margin:0;">...</p>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                 <span id="m-vendor" style="font-size:12px; color:#888; font-weight:bold;"></span>
                 <span id="m-condition" style="font-size:12px; padding:4px 10px; background:#eee; border-radius:10px; color:#555;"></span>
            </div>

            <a id="m-btn" href="#" target="_blank" class="chat-btn" style="width:100%; text-align:center; display:block; padding:15px; border-radius:10px;">
                <i class="fab fa-whatsapp"></i> Chat with Vendor
            </a>
        </div>
    </div>

    <footer class="site-footer">
        <p style="margin-top:20px; color:#777; font-size: 12px;">
    &copy; 2026 All rights reserved. Powered by 
    <a href="https://brightsitedev.tech" target="_blank" style="color:#2d8eff; text-decoration:none; font-weight:bold;">Brightsitedev</a>
</p>
    </footer>
  </div>

  <script src="asset/script.js"></script>

  <script>
    // --- SUPABASE CONFIG ---
    const supabaseUrl = "https://mofdxngxakijeokaylwt.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZmR4bmd4YWtpamVva2F5bHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzYyMjAsImV4cCI6MjA4NDg1MjIyMH0.PqyNGp7Yp01ScCMDr4ta6GQPVqxa6A476Lz9cYKj3dE";
    
    // Use 'sbClient'
    const sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Global Vars
    let savedItemIds = new Set();
    let activeUser = null;
    let allCategoryItems = [];
    let filteredList = [];
    let currentCount = 0;
    const INITIAL_LOAD = 30;
    const LOAD_STEP = 20;
    const ADMIN_PHONE = "2348144516127";

    // --- AUTH & INIT ---
    document.addEventListener("DOMContentLoaded", async () => {
        // 1. Check User
        const localData = localStorage.getItem('user_data');
        if(localData) {
            activeUser = JSON.parse(localData);
            loadSavedItems();
        } else {
            const { data: { user } } = await sbClient.auth.getUser();
            if(user) {
                activeUser = user;
                loadSavedItems();
            }
        }

        // 2. Get Category from URL
        const params = new URLSearchParams(window.location.search);
        let category = params.get('cat');

        if(category) {
            // Capitalize first letter for display
            const displayTitle = category.charAt(0).toUpperCase() + category.slice(1);
            document.title = `${displayTitle} | AFIT Market`;
            document.getElementById('page-title').innerText = displayTitle;

            loadCategoryItems(category);
        } else {
            document.getElementById('preloader').style.display = 'none';
            document.getElementById('category-grid').innerHTML = "<p style='padding:20px;'>No category specified.</p>";
        }

        // 3. Search Listener
        document.getElementById('cat-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if(!term) {
                filteredList = allCategoryItems;
            } else {
                filteredList = allCategoryItems.filter(p => p.title.toLowerCase().includes(term));
            }
            // Reset & Render
            currentCount = 0;
            document.getElementById('category-grid').innerHTML = "";
            document.getElementById('result-count').innerText = `${filteredList.length} items found`;
            renderNextBatch();
        });

        // 4. Load More Button
        document.getElementById('load-more-btn').addEventListener('click', renderNextBatch);
    });

    // --- FETCH DATA ---
    async function loadCategoryItems(category) {
        try {
            // Fetch Products + Join Vendors (Only Approved Vendors)
            // Note: We use !inner to filter rows based on the joined table
            const { data: products, error } = await sbClient
                .from('products')
                .select('*, vendors!inner(vendor_unique_id, phone_number, is_approved)')
                .ilike('category', category) // Case-insensitive match
                .eq('vendors.is_approved', true);

            if(error) throw error;

            // Map data to simpler structure
            const mappedItems = products.map(p => ({
                id: p.id,
                title: p.title,
                price: p.price,
                description: p.description,
                image: p.image_url,
                condition: "Used", // Default
                is_sold: p.is_sold,
                vendor_id: p.vendors?.vendor_unique_id || "Unknown",
                phone: p.vendors?.phone_number || ADMIN_PHONE
            }));

            // Shuffle for randomness
            allCategoryItems = shuffleArray(mappedItems);
            filteredList = allCategoryItems;

            document.getElementById('result-count').innerText = `${filteredList.length} items found`;
            document.getElementById('category-grid').innerHTML = "";

            if(filteredList.length === 0) {
                 document.getElementById('category-grid').innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#888;"><p>No ${category} available right now.</p></div>`;
                 document.getElementById('preloader').style.display = 'none';
                 return;
            }

            renderNextBatch();
            document.getElementById('preloader').style.display = 'none';

        } catch (err) {
            console.error("Error loading category:", err);
            document.getElementById('category-grid').innerHTML = "<p style='padding:20px;'>Error loading items.</p>";
            document.getElementById('preloader').style.display = 'none';
        }
    }

    function renderNextBatch() {
        const grid = document.getElementById('category-grid');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');

        const batchSize = (currentCount === 0) ? INITIAL_LOAD : LOAD_STEP;
        const nextItems = filteredList.slice(currentCount, currentCount + batchSize);

        nextItems.forEach(p => {
            const priceFormatted = "â‚¦" + Number(p.price).toLocaleString();
            
            // Safe Strings for HTML
            const safeNameJS = p.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeDescJS = (p.description || "").replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, " ");
            
            // Save Status
            const isSaved = savedItemIds.has(p.id);
            const heartClass = isSaved ? 'fas' : 'far';
            const heartColor = isSaved ? '#ff4757' : '#777';

            // Sold Status
            const opacity = p.is_sold ? 'opacity:0.6;' : '';
            const badge = p.is_sold ? '<span style="background:red; color:white; font-size:9px; padding:2px 5px; position:absolute; top:10px; left:10px; border-radius:4px; z-index:10;">SOLD</span>' : '';
            
            const btnText = p.is_sold ? "Sold" : "Get Item";
            const btnStyle = p.is_sold ? "background:#777; pointer-events:none;" : "";
            const btnAction = p.is_sold ? "" : `openDetailModal('${safeNameJS}', '${priceFormatted}', '${safeDescJS}', '${p.vendor_id}', '${p.condition}', '${p.phone}')`;

            grid.innerHTML += `
            <div class="ad-card" style="position:relative; ${opacity}">
                ${badge}
                <button onclick="toggleSave('${p.id}')" class="save-btn" id="save-${p.id}"
                    style="position:absolute; top:10px; right:10px; background:white; border:none; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:10;">
                    <i class="${heartClass} fa-heart" style="color:${heartColor}; font-size:16px;"></i>
                </button>
                <img class="ad-img" src="${p.image}" alt="${p.title}" onerror="this.src='img/logo-blue.png'">
                <div class="ad-info">
                    <div class="ad-price">${priceFormatted}</div>
                    <div class="ad-title">${p.title}</div>
                    <div class="ad-desc-preview">${(p.description || "").substring(0, 40)}...</div>
                    <div class="ad-location">Vendor: ${p.vendor_id}</div>
                    <button onclick="${btnAction}" class="chat-btn" style="width:100%; margin-top:5px; border:none; cursor:pointer; ${btnStyle}">${btnText}</button>
                </div>
            </div>`;
        });

        currentCount += nextItems.length;

        if (currentCount >= filteredList.length) {
            loadMoreContainer.style.display = 'none';
        } else {
            loadMoreContainer.style.display = 'block';
            loadMoreBtn.innerText = "Load More";
        }
    }

    // --- UTILS ---
    window.openDetailModal = function(title, price, desc, vendor, cond, phone) {
        document.getElementById('m-title').innerText = title;
        document.getElementById('m-price').innerText = price;
        document.getElementById('m-desc').innerText = desc;
        document.getElementById('m-vendor').innerText = "Vendor: " + vendor;
        document.getElementById('m-condition').innerText = cond;
        
        const waMsg = encodeURIComponent(`Hi, I saw "${title}" on AFIT Market (Price: ${price}). Is it available?`);
        document.getElementById('m-btn').href = `https://wa.me/${phone}?text=${waMsg}`;
        
        document.getElementById('detail-modal').style.display = 'flex';
    };

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- SAVE FEATURE ---
    async function loadSavedItems() {
        if(!activeUser) return;
        const { data } = await sbClient.from('saved_items').select('product_id').eq('user_id', activeUser.id);
        if(data) data.forEach(item => savedItemIds.add(item.product_id));
        updateHeartIcons();
    }

    window.toggleSave = async function(pid) {
        if (!activeUser) { 
            if(confirm("Sign in to save items?")) window.location.href = "login.html"; 
            return; 
        }
        
        const btnIcon = document.querySelector(`#save-${pid} i`);
        
        if (savedItemIds.has(pid)) {
            savedItemIds.delete(pid);
            btnIcon.classList.replace('fas', 'far'); btnIcon.style.color = '#777';
            await sbClient.from('saved_items').delete().eq('user_id', activeUser.id).eq('product_id', pid);
        } else {
            savedItemIds.add(pid);
            btnIcon.classList.replace('far', 'fas'); btnIcon.style.color = '#ff4757';
            await sbClient.from('saved_items').insert({ user_id: activeUser.id, product_id: pid });
        }
    };

    function updateHeartIcons() {
        document.querySelectorAll('.save-btn').forEach(btn => {
            const id = btn.id.replace('save-', '');
            const icon = btn.querySelector('i');
            if (savedItemIds.has(id)) {
                icon.classList.replace('far', 'fas'); icon.style.color = '#ff4757';
            }
        });
    }
  </script>
</body>
</html>