<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>All Vendors - AFIT Digital Market</title>
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../asset/style.css"> 
  <link rel="icon" href="../img/app-logo.png" type="image/png" sizes="192x192">
  <link rel="apple-touch-icon" href="../img/app-logo.png">
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

  <div class="app-container">
    <div class="header">
      <a href="../index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
      <span style="font-weight:bold;">All Vendors</span>
    </div>

    <div class="cat-search-container">
        <div class="search-wrapper cat-search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="vendor-search" class="search-input" placeholder="Search vendor by name or ID...">
        </div>
    </div>

    <div class="trending-grid" id="all-vendors-container" style="padding: 15px;">
        <div class="skeleton-card"><div class="skeleton sk-img"></div><div class="skeleton sk-text-short"></div></div>
        <div class="skeleton-card"><div class="skeleton sk-img"></div><div class="skeleton sk-text-short"></div></div>
        <div class="skeleton-card"><div class="skeleton sk-img"></div><div class="skeleton sk-text-short"></div></div>
        <div class="skeleton-card"><div class="skeleton sk-img"></div><div class="skeleton sk-text-short"></div></div>
    </div>

    <footer class="site-footer">
        <p style="margin-top:20px; color:#777; font-size: 12px;">
    &copy; 2026 All rights reserved. Powered by 
    <a href="https://brightsitedev.tech" target="_blank" style="color:#2d8eff; text-decoration:none; font-weight:bold;">Brightsitedev</a>
</p>
    </footer>
  </div>

  <script src="../asset/script.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const container = document.getElementById('all-vendors-container');

        // 1. CHECK IF SUPABASE LOADED
        if (typeof window.supabase === 'undefined') {
            container.innerHTML = "<p style='color:red; text-align:center;'>Error: Supabase failed to load. Check internet.</p>";
            return;
        }

        // 2. CONFIG
        const supabaseUrl = "https://mofdxngxakijeokaylwt.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZmR4bmd4YWtpamVva2F5bHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzYyMjAsImV4cCI6MjA4NDg1MjIyMH0.PqyNGp7Yp01ScCMDr4ta6GQPVqxa6A476Lz9cYKj3dE";
        const sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        try {
            // 3. FETCH VENDORS (Only Approved ones)
            const { data: vendors, error } = await sbClient
                .from('vendors')
                .select('*')
                .eq('is_approved', true);

            if (error) {
                console.error("Supabase Error:", error);
                container.innerHTML = `<p style='text-align:center; color:red;'>Error: ${error.message}</p>`;
                return;
            }

            container.innerHTML = ""; // Clear Skeletons

            if (!vendors || vendors.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:20px; color:#777;'>No active vendors found.</p>";
                return;
            }

            // 4. SHUFFLE & RENDER
            const shuffled = vendors.sort(() => 0.5 - Math.random());

            shuffled.forEach(v => {
                const vName = v.business_name || "Vendor";
                const vDesc = v.description || "Campus Vendor";
                const vID = v.vendor_unique_id || "V---"; // The V060 ID
                
                // Image Handling
                let img = v.logo_url;
                if (!img) img = "../img/person.png";
                else if (!img.startsWith('http')) img = `../img/${img}`;

                // Blue Tick
                const badgeHtml = '<i class="fas fa-check-circle tick-blue"></i>';

                container.innerHTML += `
                <div class="vendor-card">
                    <img src="${img}" class="vendor-logo" alt="Logo" onerror="this.src='../img/person.png'">
                    <span class="vendor-id">${vID}</span>
                    <div class="vendor-name">${vName} ${badgeHtml}</div>
                    <div class="vendor-cat">${vDesc.substring(0, 25)}...</div>
                    <button class="view-vendor-btn" onclick="window.location.href='../profile.html?vendor=${vID}'">View Vendor</button>
                </div>`;
            });

            // 5. SETUP SEARCH
            const searchInput = document.getElementById('vendor-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    document.querySelectorAll('.vendor-card').forEach(card => {
                        const text = card.innerText.toLowerCase();
                        card.style.display = text.includes(query) ? "" : "none";
                    });
                });
            }

        } catch (err) {
            console.error("Critical Error:", err);
            container.innerHTML = "<p style='text-align:center; color:red;'>Failed to load vendors.</p>";
        }
    });
  </script>

</body>
</html>