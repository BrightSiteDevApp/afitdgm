<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-70VSGR5WBW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-70VSGR5WBW');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>All Vendors - AFIT Digital Market</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../asset/style.css"> 
   <link rel="icon" href="../img/app-logo.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="../img/app-logo.png">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>
<body>

  <div class="app-container">
    <div class="header">
      <a href="../index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
      <span style="font-weight:bold;">All Vendors</span>
    </div>

    <div class="cat-search-container">
        <div class="search-wrapper cat-search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="vendor-search" class="search-input" placeholder="Search vendor by name or ID...">
        </div>
    </div>

    <div class="trending-grid" id="all-vendors-container" style="padding: 15px;">
        
        <div class="skeleton-card">
            <div class="skeleton sk-img"></div> <div class="skeleton sk-text-short"></div>
            <div class="skeleton sk-text-long"></div>
            <div class="skeleton sk-btn"></div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton sk-img"></div>
            <div class="skeleton sk-text-short"></div>
            <div class="skeleton sk-text-long"></div>
            <div class="skeleton sk-btn"></div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton sk-img"></div>
            <div class="skeleton sk-text-short"></div>
            <div class="skeleton sk-text-long"></div>
            <div class="skeleton sk-btn"></div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton sk-img"></div>
            <div class="skeleton sk-text-short"></div>
            <div class="skeleton sk-text-long"></div>
            <div class="skeleton sk-btn"></div>
        </div>

    </div>

    <footer class="site-footer">
        <p style="margin-top:20px; color:#777; font-size: 12px;">
    &copy; 2026 All rights reserved. Powered by 
    <a href="https://brightsitedev.tech" target="_blank" style="color:#2d8eff; text-decoration:none; font-weight:bold;">Brightsitedev</a>
</p>
    </footer>
  </div>

  <script src="../asset/script.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA1eQbrJpH9OtDNDN7z9oTFTRSAE7vCFbg",
        authDomain: "afit-market-auth.firebaseapp.com",
        projectId: "afit-market-auth",
        storageBucket: "afit-market-auth.firebasestorage.app",
        messagingSenderId: "894920886640",
        appId: "1:894920886640:web:77d0a6b39bf89ff8f767b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const sheetID = "1SvVUbEnDgqgw2Z_M1ShQkzyFTsnnS6n8mTs7UMXVvF4";
    const apiRoot = `https://opensheet.elk.sh/${sheetID}`;

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // 1. Get Suspended List from Firestore
            const suspendedSnap = await getDocs(collection(db, "vendor_status"));
            const suspendedVendors = new Set();
            suspendedSnap.forEach(doc => {
                if (doc.data().status === "suspended") {
                    suspendedVendors.add(doc.id);
                }
            });

            // 2. Fetch BOTH Sheets (Original & V2)
            const [data1, data2] = await Promise.all([
                fetch(`${apiRoot}/Vendors`).then(res => res.json()),
                fetch(`${apiRoot}/Vendors_v2`).then(res => res.json().catch(() => [])) // Catch error if empty
            ]);

            // 3. Merge Data
            const allVendors = [...data1, ...data2];
            
            const container = document.getElementById('all-vendors-container');
            container.innerHTML = "";

            // 4. Filter: Must NOT be suspended AND Verified must NOT be "FALSE"
            const activeVendors = allVendors.filter(v => {
                const vID = v.vendor_id || v.Vendor_ID;
                const isVerified = String(v.verified || v.Verified || "").toLowerCase().trim();
                
                // Hide if suspended OR if Verification is strictly "false" (pending)
                return !suspendedVendors.has(vID) && isVerified !== "false";
            });

            if(activeVendors.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:20px; color:#777;'>No active vendors found.</p>";
                return;
            }

            // Shuffle active vendors
            const shuffled = activeVendors.sort(() => 0.5 - Math.random());

            shuffled.forEach(v => {
                const vName = v.business_name || v.Business_Name;
                const vDesc = v.description || v.Description;
                const vImage = v.image || v.Image;
                const vID = v.vendor_id || v.Vendor_ID;
                const vVerified = String(v.verified || v.Verified || "").toLowerCase().trim();

                let img = vImage || "logo-blue.png";
                if (!img.startsWith('http')) img = `../img/${img}`;
                
                let badgeHtml = "";
                if (vVerified === "gold") badgeHtml = '<i class="fas fa-check-circle tick-gold"></i>';
                else if (vVerified === "blue") badgeHtml = '<i class="fas fa-check-circle tick-blue"></i>';

                container.innerHTML += `
                <div class="vendor-card">
                    <img src="${img}" class="vendor-logo" alt="Logo" onerror="this.src='../img/person.png'">
                    <span class="vendor-id">${vID}</span>
                    <div class="vendor-name">${vName} ${badgeHtml}</div>
                    <div class="vendor-cat">${vDesc.substring(0, 20)}...</div>
                    <button class="view-vendor-btn" onclick="window.location.href='../profile.html?vendor=${vID}'">View Vendor</button>
                </div>`;
            });

            // Search functionality
            const searchInput = document.getElementById('vendor-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    document.querySelectorAll('.vendor-card').forEach(card => {
                        const text = card.innerText.toLowerCase();
                        card.style.display = text.includes(query) ? "" : "none";
                    });
                });
            }
        } catch (err) {
            console.error("Error loading vendors:", err);
            document.getElementById('all-vendors-container').innerHTML = "<p style='text-align:center; color:red;'>Failed to load vendors.</p>";
        }
    });
</script>

</body>
</html>