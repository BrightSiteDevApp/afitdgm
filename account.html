<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - AFIT Digital Market</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="img/app-logo.png" type="image/png" sizes="192x192">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .profile-card {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .profile-img-large {
            width: 80px; height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f0f0f0;
            margin-bottom: 10px;
        }
        
        .account-option {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            text-decoration: none;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: transform 0.2s;
            border: 1px solid transparent;
        }
        .account-option:active { transform: scale(0.98); }
        
        .option-icon {
            width: 40px; height: 40px;
            background: #f5f7fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #555;
            font-size: 18px;
        }
        .option-text { flex: 1; font-size: 14px; font-weight: 600; }
        
        /* Dark Mode */
        body.dark-mode .profile-card, body.dark-mode .account-option { background: #222; color: white; }
        body.dark-mode .option-icon { background: #333; color: #ccc; }
    </style>
</head>
<body data-page="account">

    <div class="app-container">
        <div class="header">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <span style="font-weight:bold;">My Account</span>
            <div style="width:30px;"></div>
        </div>

        <div id="account-loader" style="text-align:center; padding:100px 20px;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:30px; color:#2d8eff;"></i>
            <p style="color:#777; font-size:12px; margin-top:15px;">Loading profile...</p>
        </div>

        <div id="account-content" style="padding: 15px; display: none;">
            
            <div class="profile-card">
                <img src="img/person.png" id="user-img" class="profile-img-large" onerror="this.src='img/person.png'">
                <h3 id="user-name" style="margin:0; font-size:20px;">Student</h3>
                <p id="user-email" style="margin:5px 0 0; color:#777; font-size:13px;">...</p>
                <div id="vendor-badge" style="display:none; margin-top:10px;">
                    <span style="background:#e3f2fd; color:#2d8eff; padding:4px 10px; border-radius:15px; font-size:11px; font-weight:bold;">Verified Vendor</span>
                </div>
            </div>

            <div style="margin-top: 30px;">
                
                <a href="admin.html" id="btn-admin" class="account-option" style="display: none; background: #f3e5f5; border-color: #9c27b0;">
                    <div class="option-icon" style="background: #9c27b0; color: white;"><i class="fas fa-user-shield"></i></div>
                    <div class="option-text" style="color: #9c27b0;">Super Admin Panel</div>
                    <i class="fas fa-chevron-right" style="color: #9c27b0;"></i>
                </a>

                <a href="dashboard.html" id="btn-dashboard" class="account-option" style="display: none; background: #eef7ff; border-color: #2d8eff;">
                    <div class="option-icon" style="background: #2d8eff; color: white;"><i class="fas fa-store"></i></div>
                    <div class="option-text" style="color: #2d8eff;">Open Vendor Dashboard</div>
                    <i class="fas fa-chevron-right" style="color: #2d8eff;"></i>
                </a>

                <a href="saved.html" class="account-option">
                    <div class="option-icon"><i class="far fa-heart"></i></div>
                    <div class="option-text">Saved Items</div>
                    <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                </a>

                <a href="requests.html" class="account-option">
                    <div class="option-icon"><i class="fas fa-bullhorn"></i></div>
                    <div class="option-text">My Requests</div>
                    <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                </a>

                <a href="https://wa.me/2349153375488?text=I%20need%20help%20with..." class="account-option">
                    <div class="option-icon"><i class="fas fa-headset"></i></div>
                    <div class="option-text">Contact Support</div>
                    <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                </a>

                <a href="#" onclick="handleLogout()" class="account-option" style="margin-top: 30px; background: #fff5f6;">
                    <div class="option-icon" style="background: #ff4757; color: white;"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="option-text" style="color: #ff4757;">Log Out</div>
                </a>
            </div>
        </div>
    </div>

    <script src="asset/script.js"></script>

    <script>
        // --- SUPABASE CONFIG ---
        const supabaseUrl = "https://mofdxngxakijeokaylwt.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZmR4bmd4YWtpamVva2F5bHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzYyMjAsImV4cCI6MjA4NDg1MjIyMH0.PqyNGp7Yp01ScCMDr4ta6GQPVqxa6A476Lz9cYKj3dE";
        
        // ðŸŸ¢ FIX: We use 'sbClient' instead of 'supabase' to prevent the crash
        const sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        const ADMIN_EMAIL = "afitdgm@gmail.com";

        document.addEventListener("DOMContentLoaded", async () => {
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

            // 1. Check CUSTOM AUTH (From localStorage)
            const customData = localStorage.getItem('user_data');
            const customRole = localStorage.getItem('user_role');

            if (customData) {
                // User logged in via Email/Password
                try {
                    const user = JSON.parse(customData);
                    renderProfile({
                        name: user.full_name || user.business_name || "User",
                        email: user.email,
                        image: user.avatar_url || user.logo_url || "img/person.png",
                        role: customRole
                    });
                } catch (e) {
                    console.error("Auth Data Error:", e);
                    localStorage.removeItem('user_data');
                    window.location.href = "login.html";
                }
            } else {
                // 2. Check GOOGLE AUTH (Supabase Session)
                const { data: { user } } = await sbClient.auth.getUser();
                
                if (user) {
                    // Check if this Google user is a Vendor
                    const { data: vendorData } = await sbClient
                        .from('vendors')
                        .select('*')
                        .eq('email', user.email)
                        .single();
                    
                    renderProfile({
                        name: user.user_metadata.full_name || user.email.split('@')[0],
                        email: user.email,
                        image: user.user_metadata.avatar_url || "img/person.png",
                        role: vendorData ? 'vendor' : 'student'
                    });
                } else {
                    // No Login Found
                    window.location.href = "login.html";
                }
            }
        });

        function renderProfile(user) {
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('user-img').src = user.image;

            if (user.email && user.email.toLowerCase() === ADMIN_EMAIL) {
                document.getElementById('btn-admin').style.display = "flex";
            }

            if (user.role === 'vendor') {
                document.getElementById('btn-dashboard').style.display = "flex";
                document.getElementById('vendor-badge').style.display = "block";
            }

            document.getElementById('account-loader').style.display = 'none';
            document.getElementById('account-content').style.display = 'block';
        }

        window.handleLogout = async () => {
            if(confirm("Log out now?")) {
                localStorage.removeItem('user_data');
                localStorage.removeItem('user_role');
                await sbClient.auth.signOut();
                window.location.href = "index.html";
            }
        };
    </script>
</body>
</html>