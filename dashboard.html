<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Dashboard - AFIT Market</title>
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="img/app-logo.png" type="image/png" sizes="192x192">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Dashboard Styles */
        .dash-header {
            background: linear-gradient(135deg, #2d8eff, #6c5ce7);
            color: white;
            padding: 25px 20px 40px;
            border-radius: 0 0 25px 25px;
            margin-bottom: -30px;
            box-shadow: 0 4px 15px rgba(45, 142, 255, 0.3);
        }
        
        /* NEW: Subscription Info Box */
        .plan-info-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 15px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
        .plan-value { font-size: 13px; font-weight: bold; margin-top: 2px; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .stat-num { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { font-size: 11px; color: #777; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* Floating Add Button */
        .fab-add {
            position: fixed; bottom: 25px; right: 25px;
            background: #2d8eff; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; box-shadow: 0 4px 15px rgba(45, 142, 255, 0.5);
            cursor: pointer; z-index: 100; transition: transform 0.2s;
        }
        .fab-add:active { transform: scale(0.9); }

        /* Modal */
        .upload-modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 2000; justify-content: center; align-items: flex-end;
        }
        .upload-content {
            background: white; width: 100%; max-width: 500px;
            border-radius: 25px 25px 0 0; padding: 30px 25px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 10px; font-size: 14px; box-sizing: border-box; background: #f9f9f9;
        }

        /* ACTIONS BAR ON CARD */
        .card-actions {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            display: flex; gap: 5px;
        }
        .action-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 12px;
        }
        .btn-del { background: rgba(255, 71, 87, 0.9); }
        .btn-sold { background: rgba(46, 204, 113, 0.9); } 
        .btn-sold.is-sold { background: rgba(50, 50, 50, 0.9); }
        .btn-edit { background: rgba(52, 152, 219, 0.9); } 

        /* LIMIT POPUP */
        .limit-alert {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; padding: 20px;
        }
        .limit-box {
            background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 300px;
            animation: popIn 0.3s ease;
        }

        /* LOAD MORE BUTTON */
        #load-more-container { text-align: center; margin: 20px 0; display: none; }
        #load-more-btn {
            background: #333; color: white; border: none; padding: 10px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; font-size: 13px;
        }
        #load-more-btn:active { transform: scale(0.95); }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Dark Mode */
        body.dark-mode .stat-card, body.dark-mode .upload-content, body.dark-mode .limit-box { background: #1e1e1e; color: white; }
        body.dark-mode .form-input { background: #333; border-color: #444; color: white; }
        body.dark-mode .stat-num { color: white; }
        body.dark-mode .dash-header { box-shadow: none; border-bottom: 1px solid #333; }
        body.dark-mode #load-more-btn { background: #444; }
    </style>
</head>
<body data-page="dashboard">

    <script>
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    </script>

    <div class="app-container" id="main-content" style="display: none;">
        
        <div class="dash-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <a href="index.html" style="color:white;"><i class="fas fa-arrow-left"></i> Home</a>
                <div id="vendor-badge" style="font-size:10px; background:rgba(255,255,255,0.25); padding:4px 10px; border-radius:15px; font-weight:bold;">
                    Checking...
                </div>
            </div>
            
            <h2 style="margin-top:20px; font-size:22px; margin-bottom: 5px;">Hi, <span id="dash-name">...</span></h2>
            
            <div style="font-size:12px; opacity:0.9; margin-top:5px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-crown" style="color:#ffd700;"></i> 
                Limit: <span id="limit-display">...</span> items
            </div>

            <div class="plan-info-box">
                <div>
                    <div class="plan-label">Current Plan</div>
                    <div class="plan-value" id="sub-plan">Loading...</div>
                </div>
                <div style="text-align: right;">
                    <div class="plan-label">Due Date</div>
                    <div class="plan-value" id="sub-due">---</div>
                </div>
            </div>

        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-num" id="item-count">0</div>
                <div class="stat-label">Used Slots</div>
            </div>
            <div class="stat-card">
                <div class="stat-num" id="view-count">--</div>
                <div class="stat-label">Total Views</div>
            </div>
        </div>

        <div id="status-message" style="text-align:center; padding:30px; color:#777; font-size:14px;">
            <i class="fas fa-circle-notch fa-spin"></i> Loading Dashboard...
        </div>

        <div style="padding: 0 15px 80px;">
            <h4 style="margin-bottom:15px; font-size: 16px;">Active Inventory</h4>
            <div id="my-items-grid" class="trending-grid">
            </div>
            
            <div id="load-more-container">
                <button id="load-more-btn">Load More</button>
            </div>
        </div>

    </div>

    <div class="fab-add" id="add-btn" style="display:none;" onclick="openNewUpload()">
        <i class="fas fa-plus"></i>
    </div>

    <div id="upload-modal" class="upload-modal">
        <div class="upload-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;" id="modal-title">New Item</h3>
                <i class="fas fa-times" onclick="closeUploadModal()" style="font-size:20px; color:#777; cursor:pointer;"></i>
            </div>

            <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" id="p-name" class="form-input" placeholder="e.g. iPhone 12 UK Used">
            </div>

            <div class="form-group">
                <label class="form-label">Price (Just type the number, e.g. 15000)</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 15px; top: 12px; font-weight: bold; color: #555;">₦</span>
                    <input type="number" id="p-price" class="form-input" style="padding-left: 30px;" placeholder="15000">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <input type="text" id="p-desc" class="form-input" placeholder="Short description...">
            </div>

            <div class="form-group"> 
                <label class="form-label">Category</label>
                <select id="p-cat" class="form-input">
                    <option value="Phones">Phones</option>
                    <option value="Laptops">Laptops</option>
                    <option value="Fashion">Fashion</option>
                    <option value="Valentine">Valentine</option>
                    <option value="Fashion Accessories">Fashion Accessories</option>
                    <option value="Fragrance">Fragrance</option>
                    <option value="Phone Accessories">Phone Accessories</option>
                    <option value="Gadgets">Gadgets</option>
                    <option value="Hair Service">Hair Service</option>
                    <option value="Food">Food</option>
                    <option value="Footwear">Footwear</option>
                    <option value="Pastries">Pastries</option>
                    <option value="Services">Services</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Condition</label>
                <select id="p-condition" class="form-input">
                    <option value="New">New</option>
                    <option value="Used" selected>Used</option>
                    <option value="Refurbished">Refurbished</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Photo <span id="photo-label" style="font-weight:normal; color:#2d8eff;"></span></label>
                <input type="file" id="p-file" class="form-input" accept="image/*">
            </div>

            <button id="btn-submit" class="chat-btn" style="width:100%; background:#2d8eff; height: 50px; font-size: 16px;">Post Item</button>
        </div>
    </div>

    <div id="limit-modal" class="limit-alert">
        <div class="limit-box">
            <i class="fas fa-lock" style="font-size:50px; color:#ff4757; margin-bottom:20px;"></i>
            <h3 style="margin:0; color:#333;">Limit Reached!</h3>
            <p style="color:#777; font-size:14px; margin: 10px 0 20px;">You have used all <b id="alert-limit"></b> slots.</p>
            <p style="font-size:12px; color:#555;">Upgrade your plan to post more items.</p>
            <a href="https://wa.me/2348144516127?text=Hi%20Admin,%20I%20want%20to%20upgrade%20my%20vendor%20plan." class="chat-btn" style="width:100%; display:block; margin-top:10px;">Contact Admin</a>
            <button onclick="closeLimitModal()" style="background:none; border:none; color:#999; margin-top:15px; cursor:pointer;">Close</button>
        </div>
    </div>

    <script src="asset/script.js"></script>

    <script>
        // --- SUPABASE SETUP ---
        const supabaseUrl = "https://mofdxngxakijeokaylwt.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZmR4bmd4YWtpamVva2F5bHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzYyMjAsImV4cCI6MjA4NDg1MjIyMH0.PqyNGp7Yp01ScCMDr4ta6GQPVqxa6A476Lz9cYKj3dE";
        
        // Use 'sbClient' to prevent naming conflicts
        const sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ImgBB Key (Keep this)
        const IMGBB_KEY = "2ac38bef2c73c5a65e7ddf94efe37962";

        // Global Variables
        let activeVendorUUID = null;
        let maxItems = 5; 
        let currentCount = 0;
        let isEditing = false;
        let editDocID = null;
        let currentImageURL = "";
        let allFetchedItems = []; 
        let renderedCount = 0; 
        const INITIAL_LOAD = 20;
        const LOAD_STEP = 10;

        function escapeHTML(str) {
            if (!str) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.addEventListener("DOMContentLoaded", async () => {
            
            // 1. AUTH CHECK
            let vendor = null;
            const statusMsg = document.getElementById('status-message');

            // A) Check LocalStorage (Custom Login)
            const localData = localStorage.getItem('user_data');
            const localRole = localStorage.getItem('user_role');

            if(localData && localRole === 'vendor') {
                vendor = JSON.parse(localData);
            } 
            // B) Check Supabase Session (Google Login)
            else {
                const { data: { user } } = await sbClient.auth.getUser();
                if (user) {
                    // Fetch from 'vendors' table using email
                    const { data: vData } = await sbClient
                        .from('vendors')
                        .select('*')
                        .eq('email', user.email)
                        .single();
                    if(vData) vendor = vData;
                }
            }

            // 2. LOAD DASHBOARD
            if (vendor) {
                // We have a verified vendor
                activeVendorUUID = vendor.id;
                maxItems = vendor.slots_total || 5;

                // UI Updates
                document.getElementById('dash-name').innerText = vendor.business_name;
                document.getElementById('sub-plan').innerText = vendor.subscription_plan || "Basic";
                document.getElementById('sub-due').innerText = vendor.next_payment_due || "N/A"; // Make sure you have this column or it will show N/A
                document.getElementById('vendor-badge').innerText = `ID: ${vendor.vendor_unique_id}`;
                document.getElementById('limit-display').innerText = maxItems;
                
                // Show Content
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('add-btn').style.display = 'flex';
                statusMsg.style.display = 'none';

                loadMyItems();

            } else {
                // Not logged in or not a vendor
                alert("Access Denied: Please log in as a vendor.");
                window.location.href = "login.html";
            }
        });

        // --- FETCH ITEMS ---
        async function loadMyItems() {
            document.getElementById('load-more-btn').addEventListener('click', renderBatch);
            const grid = document.getElementById('my-items-grid');
            grid.innerHTML = "";

            try {
                // Fetch from Supabase Products Table
                const { data: products, error } = await sbClient
                    .from('products')
                    .select('*')
                    .eq('vendor_id', activeVendorUUID) // Using UUID
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allFetchedItems = products;
                currentCount = allFetchedItems.length;

                // Update Stats
                document.getElementById('item-count').innerText = `${currentCount} / ${maxItems}`;
                if(currentCount >= maxItems) document.getElementById('item-count').style.color = "#ff4757";

                // Count Views
                const totalViews = allFetchedItems.reduce((sum, item) => sum + (item.views_count || 0), 0);
                document.getElementById('view-count').innerText = totalViews;

                if(allFetchedItems.length === 0) {
                    grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#999;">You haven't posted any items yet.</p>`;
                    document.getElementById('load-more-container').style.display = 'none';
                    return;
                }

                renderedCount = 0;
                renderBatch();

            } catch (err) { console.error("Error loading items:", err); }
        }

        function renderBatch() {
            const grid = document.getElementById('my-items-grid');
            const loadMoreContainer = document.getElementById('load-more-container');
            const loadMoreBtn = document.getElementById('load-more-btn');

            const batchSize = (renderedCount === 0) ? INITIAL_LOAD : LOAD_STEP;
            const nextItems = allFetchedItems.slice(renderedCount, renderedCount + batchSize);

            nextItems.forEach(data => {
                const isStory = data.is_flash_sale === true;
                const isSold = data.is_sold === true;
                const badge = isStory ? '<span style="background:#ff4757; color:white; font-size:9px; padding:2px 5px; border-radius:4px; margin-left:5px;">⚡ FLASH</span>' : '';
                
                const opacity = isSold ? '0.6' : '1';
                const soldBtnClass = isSold ? 'btn-sold is-sold' : 'btn-sold';
                const soldIcon = isSold ? 'fa-eye-slash' : 'fa-check';
                const soldText = isSold ? "Sold" : "Active";

                const safeNameJS = (data.title || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeDescJS = (data.description || "").replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, " ");
                const safePriceJS = data.price; // It's a number now

                const safeNameHTML = escapeHTML(data.title);
                const safePriceHTML = "₦" + Number(data.price).toLocaleString();
                
                grid.innerHTML += `
                <div class="ad-card" style="position:relative; opacity:${opacity};">
                    <div class="card-actions">
                        <button onclick="editItem('${data.id}', '${safeNameJS}', '${safePriceJS}', '${safeDescJS}', '${data.category}', 'Used', '${data.image_url}')" class="action-btn btn-edit" title="Edit Item">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="toggleSold('${data.id}', ${isSold})" class="action-btn ${soldBtnClass}" title="Mark Sold">
                            <i class="fas ${soldIcon}"></i>
                        </button>
                        <button onclick="deleteItem('${data.id}')" class="action-btn btn-del" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <img class="ad-img" src="${data.image_url}" onerror="this.src='img/logo-blue.png'">
                    <div class="ad-info">
                        <div class="ad-price">${safePriceHTML}</div>
                        <div class="ad-title">${safeNameHTML} ${badge}</div>
                        <div class="ad-location" style="font-size:10px; color:${isSold ? 'red' : 'green'};">${soldText}</div>
                    </div>
                </div>`;
            });

            renderedCount += nextItems.length;

            if (renderedCount >= allFetchedItems.length) {
                loadMoreContainer.style.display = 'none';
            } else {
                loadMoreContainer.style.display = 'block';
                loadMoreBtn.innerText = "Load More";
            }
        }

        // --- ACTIONS ---

        window.editItem = function(id, name, price, desc, cat, cond, img) {
            isEditing = true;
            editDocID = id;
            currentImageURL = img;

            document.getElementById('modal-title').innerText = "Edit Item";
            document.getElementById('btn-submit').innerText = "Update Item";
            document.getElementById('p-name').value = name;
            document.getElementById('p-price').value = price;
            document.getElementById('p-desc').value = desc;
            document.getElementById('p-cat').value = cat;
            document.getElementById('p-condition').value = cond || "Used";
            document.getElementById('photo-label').innerText = "(Leave empty to keep current photo)";

            document.getElementById('upload-modal').style.display = 'flex';
        };

        window.openNewUpload = function() {
            if (currentCount >= maxItems) {
                document.getElementById('alert-limit').innerText = maxItems;
                document.getElementById('limit-modal').style.display = 'flex';
            } else {
                isEditing = false;
                editDocID = null;
                document.getElementById('modal-title').innerText = "New Item";
                document.getElementById('btn-submit').innerText = "Post Item";
                document.getElementById('p-name').value = "";
                document.getElementById('p-price').value = "";
                document.getElementById('p-desc').value = "";
                document.getElementById('p-file').value = "";
                document.getElementById('photo-label').innerText = "";
                
                document.getElementById('upload-modal').style.display = 'flex';
            }
        };

        document.getElementById('btn-submit').addEventListener('click', async () => {
            if (!isEditing && currentCount >= maxItems) { alert("Limit Reached!"); return; }

            const btn = document.getElementById('btn-submit');
            const name = document.getElementById('p-name').value;
            const rawPrice = document.getElementById('p-price').value;
            const desc = document.getElementById('p-desc').value;
            const cat = document.getElementById('p-cat').value;
            const fileInput = document.getElementById('p-file');

            if (!name || !rawPrice) { alert("Name and Price are required."); return; }
            if (!isEditing && fileInput.files.length === 0) { alert("Please select an image."); return; }

            // Clean Price
            const priceNumber = parseFloat(rawPrice.replace(/[^0-9.]/g, ''));

            btn.innerText = isEditing ? "Updating..." : "Uploading...";
            btn.disabled = true;
            btn.style.opacity = "0.7";

            try {
                let finalImageUrl = currentImageURL;

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const formData = new FormData();
                    formData.append("image", file);
                    const imgReq = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
                    const imgData = await imgReq.json();
                    if (!imgData.success) throw new Error("Image Upload Failed");
                    finalImageUrl = imgData.data.url;
                }

                if (isEditing) {
                    const { error } = await sbClient
                        .from('products')
                        .update({
                            title: name,
                            price: priceNumber,
                            description: desc,
                            category: cat,
                            image_url: finalImageUrl
                        })
                        .eq('id', editDocID);
                    
                    if(error) throw error;
                    alert("Item Updated!");

                } else {
                    const { error } = await sbClient
                        .from('products')
                        .insert({
                            vendor_id: activeVendorUUID, // Link to this vendor
                            title: name,
                            price: priceNumber,
                            description: desc,
                            category: cat,
                            image_url: finalImageUrl,
                            is_flash_sale: false,
                            is_sold: false
                        });

                    if(error) throw error;
                    alert("Item Posted!");
                }

                closeUploadModal();
                location.reload();

            } catch (error) { 
                alert("Error: " + error.message); 
                btn.innerText = isEditing ? "Update Item" : "Post Item"; 
                btn.disabled = false; 
                btn.style.opacity = "1"; 
            }
        });

        window.toggleSold = async function(docID, currentStatus) {
            // currentStatus is boolean (true/false)
            const newStatus = !currentStatus;
            if(!confirm(`Mark as ${newStatus ? 'Sold' : 'Active'}?`)) return;
            try {
                await sbClient.from('products').update({ is_sold: newStatus }).eq('id', docID);
                loadMyItems();
            } catch(e) { alert("Error: " + e.message); }
        };

        window.deleteItem = async function(docID) {
            if(!confirm("Delete this item?")) return;
            try { 
                await sbClient.from('products').delete().eq('id', docID); 
                alert("Deleted!"); 
                location.reload(); 
            } 
            catch(e) { alert("Error deleting: " + e.message); }
        };

        window.closeUploadModal = function() { document.getElementById('upload-modal').style.display = 'none'; };
        window.closeLimitModal = function() { document.getElementById('limit-modal').style.display = 'none'; };
    </script>
</body>
</html>