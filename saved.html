<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Items - AFIT Digital Market</title>
    
    <link rel="stylesheet" href="asset/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="img/app-logo.png" type="image/png" sizes="192x192">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
      /* LOAD MORE BUTTON */
      #load-more-container { text-align: center; margin: 20px 0 40px; display: none; }
      #load-more-btn {
          background: #333; color: white; border: none; padding: 10px 25px;
          border-radius: 30px; font-weight: bold; cursor: pointer;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
      }
      #load-more-btn:active { transform: scale(0.95); }
      body.dark-mode #load-more-btn { background: #444; }

      /* --- TEXT & MODAL STYLES --- */
      .ad-title {
          white-space: normal !important;
          line-height: 1.3;
          height: auto !important;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
          margin-bottom: 5px;
      }
      .ad-desc-preview {
          font-size: 11px; color: #888;
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
          margin-bottom: 8px;
      }

      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .modal-sheet {
          background: white; width: 100%; max-width: 500px;
          border-radius: 20px 20px 0 0; padding: 25px;
          animation: slideUp 0.3s ease-out;
          position: relative;
      }

      /* Dark Mode Fixes */
      body.dark-mode .modal-sheet { background: #1e1e1e !important; color: white; }
      body.dark-mode .ad-desc-preview { color: #aaa; }
      body.dark-mode #m-desc { color: #ccc !important; }

      /* --- SKELETON LOADING STYLES --- */
      @keyframes skeleton-loading {
          0% { background-position: -200px 0; }
          100% { background-position: calc(200px + 100%) 0; }
      }

      .skeleton-card {
          background: #fff;
          border-radius: 10px;
          padding: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.05);
          display: flex;
          flex-direction: column;
          gap: 8px;
          height: 220px;
          position: relative;
      }

      .sk-img-rect { width: 100%; height: 120px; border-radius: 8px; background: #eee; background-image: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200px 100%; animation: skeleton-loading 1.5s infinite linear; }
      .sk-text-short { width: 40%; height: 15px; background: #eee; background-image: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200px 100%; border-radius: 4px; animation: skeleton-loading 1.5s infinite linear; }
      .sk-text-long { width: 90%; height: 15px; background: #eee; background-image: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200px 100%; border-radius: 4px; animation: skeleton-loading 1.5s infinite linear; }
      .sk-btn { width: 100%; height: 30px; margin-top: auto; background: #eee; background-image: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200px 100%; border-radius: 6px; animation: skeleton-loading 1.5s infinite linear; }

      /* ðŸ†• DARK MODE SKELETON FIXES */
      body.dark-mode .skeleton-card {
          background: #1e1e1e;
          box-shadow: 0 2px 10px rgba(255,255,255,0.05);
      }
      body.dark-mode .sk-img-rect,
      body.dark-mode .sk-text-short,
      body.dark-mode .sk-text-long,
      body.dark-mode .sk-btn {
          background: #333;
          background-image: linear-gradient(90deg, #333, #444, #333);
      }
  </style>
</head>
<body data-page="saved">

    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <div class="app-container">
        <div class="header">
            <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <span style="font-weight:bold;">Saved Items</span>
             <div class="notification-icon-box" id="theme-toggle" style="margin-left:auto;">
                <i class="fas fa-moon"></i>
            </div>
        </div>

        <div id="saved-skeleton" class="trending-grid" style="padding: 15px;">
            <div class="skeleton-card"><div class="sk-img-rect"></div><div class="sk-text-short"></div><div class="sk-text-long"></div><div class="sk-btn"></div></div>
            <div class="skeleton-card"><div class="sk-img-rect"></div><div class="sk-text-short"></div><div class="sk-text-long"></div><div class="sk-btn"></div></div>
        </div>

        <div id="saved-grid" class="trending-grid" style="padding: 15px; display:none;">
        </div>

        <div id="empty-state" style="display:none; text-align:center; padding:50px; color:#888;">
            <i class="far fa-heart" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
            <p>You haven't saved any items yet.</p>
            <a href="index.html" class="chat-btn" style="display:inline-block; width:auto; margin-top:15px;">Start Shopping</a>
        </div>
    </div>

    <div id="detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:end;">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h3 id="m-title" style="margin:0; font-size:18px; width:90%; line-height:1.3;">...</h3>
                <button onclick="document.getElementById('detail-modal').style.display='none'" style="background:none; border:none; font-size:24px; color:#555; cursor:pointer;">&times;</button>
            </div>
            <p id="m-price" style="color:#2d8eff; font-weight:bold; font-size:20px; margin:10px 0;">...</p>
            
            <div style="max-height:200px; overflow-y:auto; margin-bottom:20px; background:#f9f9f9; padding:10px; border-radius:10px;">
                 <p id="m-desc" style="color:#555; font-size:14px; line-height:1.5; margin:0;">...</p>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                 <span id="m-vendor" style="font-size:12px; color:#888; font-weight:bold;"></span>
            </div>

            <a id="m-btn" href="#" target="_blank" class="chat-btn" style="width:100%; text-align:center; display:block; padding:15px; border-radius:10px;">
                <i class="fab fa-whatsapp"></i> Chat with Vendor
            </a>
        </div>
    </div>

    <script src="asset/script.js"></script>

    <script>
        // --- SUPABASE CONFIG ---
        const supabaseUrl = "https://mofdxngxakijeokaylwt.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZmR4bmd4YWtpamVva2F5bHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzYyMjAsImV4cCI6MjA4NDg1MjIyMH0.PqyNGp7Yp01ScCMDr4ta6GQPVqxa6A476Lz9cYKj3dE";
        
        const sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const ADMIN_PHONE = "2348144516127";
        let activeUser = null;

        document.addEventListener("DOMContentLoaded", async () => {
            
            // Check Auth (Local or Supabase)
            const localData = localStorage.getItem('user_data');
            
            if(localData) {
                activeUser = JSON.parse(localData);
                loadSavedItems(activeUser.id);
            } else {
                const { data: { user } } = await sbClient.auth.getUser();
                if(user) {
                    activeUser = user;
                    loadSavedItems(user.id);
                } else {
                    window.location.href = "login.html";
                }
            }
        });

        async function loadSavedItems(uid) {
            const grid = document.getElementById('saved-grid');
            const skeleton = document.getElementById('saved-skeleton');
            const emptyState = document.getElementById('empty-state');

            try {
                // 1. Fetch Saved Item IDs
                const { data: saved, error } = await sbClient
                    .from('saved_items')
                    .select('product_id')
                    .eq('user_id', uid);

                if (error) throw error;

                if (!saved || saved.length === 0) {
                    skeleton.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                // 2. Fetch Full Product Details for those IDs
                const productIds = saved.map(s => s.product_id);
                
                const { data: products, error: pError } = await sbClient
                    .from('products')
                    .select('*, vendors(business_name, whatsapp_number)')
                    .in('id', productIds);

                if (pError) throw pError;

                skeleton.style.display = 'none';
                grid.style.display = 'grid';
                grid.innerHTML = "";

                // 3. Render
                products.forEach(p => {
                    const vendorName = p.vendors?.business_name || "Vendor";
                    const vendorPhone = p.vendors?.whatsapp_number || ADMIN_PHONE;
                    const price = "â‚¦" + Number(p.price).toLocaleString();
                    const img = p.image_url;
                    
                    const safeName = p.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const safeDesc = (p.description || "No description").replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, " ");

                    grid.innerHTML += `
                    <div class="ad-card" id="card-${p.id}" style="position:relative;">
                        <button onclick="removeSavedItem('${p.id}')" 
                                style="position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); border:none; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); z-index:10;">
                            <i class="fas fa-trash-alt" style="color:#ff4757; font-size:14px;"></i>
                        </button>
                        <img class="ad-img" src="${img}" onerror="this.src='img/logo-blue.png'">
                        <div class="ad-info">
                            <div class="ad-price">${price}</div>
                            <div class="ad-title">${p.title}</div>
                            <div class="ad-location">Vendor: ${vendorName}</div>
                            <button onclick="openDetailModal('${safeName}', '${price}', '${safeDesc}', '${vendorName}', '${vendorPhone}')" class="chat-btn" style="width:100%; border:none; margin-top:5px; cursor:pointer;">Get Item</button>
                        </div>
                    </div>`;
                });

            } catch (err) {
                console.error("Error loading saved:", err);
                skeleton.style.display = 'none';
                grid.innerHTML = "<p>Error loading saved items.</p>";
                grid.style.display = 'block';
            }
        }

        window.openDetailModal = function(title, price, desc, vendor, phone) {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-price').innerText = price;
            document.getElementById('m-desc').innerText = desc;
            document.getElementById('m-vendor').innerText = "Vendor: " + vendor;
            
            const waMsg = encodeURIComponent(`Hi, I saw "${title}" on AFIT Market (Price: ${price}). Is it available?`);
            document.getElementById('m-btn').href = `https://wa.me/${phone}?text=${waMsg}`;
            
            document.getElementById('detail-modal').style.display = 'flex';
        };

        window.removeSavedItem = async function(pid) {
            if(!confirm("Remove from saved items?")) return;
            const card = document.getElementById(`card-${pid}`);
            if(card) card.style.opacity = "0.5";

            try {
                // Delete from Supabase
                const { error } = await sbClient
                    .from('saved_items')
                    .delete()
                    .eq('user_id', activeUser.id)
                    .eq('product_id', pid);

                if(error) throw error;

                // Animate Removal
                if(card) {
                    card.style.transform = "scale(0)";
                    setTimeout(() => {
                        card.remove();
                        // Check if empty
                        if(document.getElementById('saved-grid').children.length === 0) {
                            document.getElementById('empty-state').style.display = 'block';
                        }
                    }, 300);
                }
            } catch (err) {
                alert("Error removing item.");
                if(card) card.style.opacity = "1";
            }
        };
    </script>
</body>
</html>